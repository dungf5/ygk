{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends 'default_frame.twig' %}

{% set mypageno = 'shipping' %}

{% set body_class = 'mypage' %}

{% block stylesheet %}
    <link rel="stylesheet" href="{{ asset('assets/css/bootstrap-multiselect.min.css') }}">
{% endblock stylesheet %}

{% block main %}
<style>
    div.multiselect-container.dropdown-menu {
        color: black;
    }
    div.open>.dropdown-menu {
        display: inline-grid;
    }
    .dropdown-item.multiselect-all {
        width: 100%;
        border: none;
        padding-bottom: 5px;
    }
    .multiselect-option.dropdown-item {
        width: 100%;
        border: none;
    }
    .multiselect-container .multiselect-all .form-check {
        float: left;
        /*padding: 0 5px 0 45px;*/
    }
    .multiselect-container .multiselect-option .form-check {
        float: left;
    }
    .multiselect-container .multiselect-all .form-check .form-check-label {
        margin-left: 10px;
    }
    .multiselect-container .multiselect-option .form-check .form-check-label {
        margin-left: 10px;
    }
    button.multiselect.dropdown-toggle.custom-select.text-center {
        height: 34px;
    }
    div.multiselect-filter.d-flex.align-items-center {
        width: 100%;
        display: inline-flex;
    }
    div.multiselect-filter.d-flex.align-items-center i {
        display: inline-flex;
        margin-top: 10px;
    }
    button.multiselect {
        display: none;
    }
</style>

<div class="ec-layoutRole__main">
    <div class="ec-mypageRole">
        <div class="ec-pageHeader">
            <h1>{{ 'front.mypage.title'|trans }}/{{ 'front.mypage.nav_shipping__history'|trans }}</h1>
        </div>
        {% include 'Mypage/navi.twig' %}
    </div>

    <style>
        .myTable>thead>tr>th {
            white-space: nowrap;
        }
    </style>

    <iframe id="my_iframe" style="display:none;"></iframe>
    <script>
            function Download(url) {
                document.getElementById('my_iframe').src = url;
            };
    </script>

    <style>
        .disBg {
            background: #A7A7A7;
            border-color: #A7A7A7;
        }
        .actBg {
         background: #0065ff;
        }
    </style>

    <div class="ec-mypageRole">
        <p class="ec-para-normal">{{ 'front.mypage.history_count'|trans({'%count%':pagination.totalItemCount}) }}</p>
        <table class="table myTable">
            <thead>
                <tr>
                    <th title="{{ 'front.mypage.shipping.delivery_no'|trans| raw }}">
                        {{ 'front.mypage.shipping.delivery_no'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.destination'|trans| raw }} {{ 'front.mypage.shipping.company_name'|trans| raw }}">
                        {{ 'front.mypage.shipping.destination'|trans| raw }} <a href="javascript:void(0)" style="color: red; {% if orderShippingOpt|length < 2 %} visibility: hidden; {% endif %}" class="multiselect dropdown-toggle search_order_shipping" onclick="handleGetLastSelected()">
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </a>
                        <br/>
                        <select id="search_order_shipping" name="search_order_shipping" multiple="multiple" onchange="handleSearch(this)">
                            {% for orderShipping in orderShippingOpt %}
                                <option value="{{orderShipping.key}}">{{orderShipping.value}}</option>
                            {% endfor %}
                        </select>
                        <br/>
                        {{ 'front.mypage.shipping.company_name'|trans| raw }} <a href="javascript:void(0)" style="color: red; {% if orderOtodokeOpt|length < 2 %} visibility: hidden; {% endif %}" class="multiselect dropdown-toggle search_order_otodoke">
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </a>
                        <br/>
                        <select id="search_order_otodoke" name="search_order_otodoke" multiple="multiple" onchange="handleSearch(this)">
                            {% for orderOtodoke in orderOtodokeOpt %}
                                <option value="{{orderOtodoke.key}}">{{orderOtodoke.value}}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th title="{{ 'front.mypage.shipping.jan_code'|trans| raw }} {{ 'front.mypage.shipping.product_name'|trans| raw }}">
                        {{ 'front.mypage.shipping.jan_code'|trans| raw }}
                        <br/>
                        {{ 'front.mypage.shipping.product_name'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.status'|trans| raw }}">
                        {{ 'front.mypage.shipping.status'|trans| raw }}
                        <a href="javascript:void(0)" style="color: red;" class="multiselect dropdown-toggle search_shipping_status">
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </a>
                        <br/>
                        <select id="search_shipping_status" name="search_shipping_status" multiple="multiple" onchange="handleSearch(this)">
                            <option value="1" {% if 1 in search_parameter.shipping_status %}selected{%  endif %}>出荷指示済</option>
                            <option value="2" {% if 2 in search_parameter.shipping_status %}selected{%  endif %}>出荷済</option>
                        </select>
                    </th>
                    <th title="{{ 'front.mypage.shipping.plan_date'|trans| raw }}">
                        {{ 'front.mypage.shipping.plan_date'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.date'|trans| raw }}">
                        {{ 'front.mypage.shipping.date'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.num'|trans| raw }}">
                        {{ 'front.mypage.shipping.num'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.note_no'|trans| raw }}">
                        {{ 'front.mypage.shipping.note_no'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.packing_slip'|trans| raw }}">
                        {{ 'front.mypage.shipping.packing_slip'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.order_number'|trans| raw }}">
                        {{ 'front.mypage.shipping.order_number'|trans| raw }}
                    </th>
                    <th title="{{ 'front.mypage.shipping.detail'|trans| raw }}">
                        {{ 'front.mypage.shipping.detail'|trans| raw }}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if pagination.totalItemCount > 0 %}
                    {% for Shipping in pagination %}
                        <tr>
                            <td>{{ Shipping.shipping_no }}</td>
                            <td>
                                {{ Shipping.shipping_name }}
                                <br/>
                                {{ Shipping.otodoke_name }}
                            </td>
                            <td>
                                {{ Shipping.jan_code }}
                                <br/>
                                {{ Shipping.product_name }}
                            </td>
                            <td>
                                {% if Shipping.shipping_status == 1 %} 出荷指示済 {% endif %}
                                {% if Shipping.shipping_status != 1 %} 出荷済 {% endif %}
                            </td>
                            <td>{{ Shipping.shipping_plan_date|date("Y年m月d日") }}</td>
                            <td>{{ Shipping.shipping_date|date("Y年m月d日") }}</td>
                            <td>{{ Shipping.shipping_num }}</td>
                            <td>
                                {% if Shipping.delivery_no is null %}
                                    空白
                                {% else %}
                                    <a href="/mypage/delivery/history?delivery_no={{Shipping.delivery_no}}" target="_blank">
                                        {{ Shipping.delivery_no }}
                                    </a>
                                {% endif %}
                            </td>
                            <td>{{ Shipping.order_lineno }}</td>
                            <td>{{ Shipping.cus_order_no }}</td>
                            <td>{{ Shipping.cus_order_lineno }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <th colspan="11">
                            <p>{{ 'front.mypage.history_not_found'|trans }}</p>
                        </th>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="ec-pagerRole">
            {% include "pager.twig" with {'pages': pagination.paginationData} %}
        </div>
    </div>
    {% include "Mypage/modal_list.twig" with {'shipping_no':'Test' } %}
</div>
{% endblock %}

{% block javascript %}
    <script src="{{ asset('assets/js/bootstrap-multiselect.min.js') }}"></script>

    <script>
        var typingTimer;
        $('#search_order_shipping').multiselect({
            // includeSelectAllOption: true,
            // selectAllText: 'すべて',
            enableFiltering: true,
            filterPlaceholder: '検索',
            disableIfEmpty: true,
            checkboxName: function(option) {
                return 'multiselect[]';
            },
            buttonWidth: '150px',
            buttonHeight: '34px',
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else if (options.length == 14) {
                    return 'すべて';
                }
                else if (options.length > 2) {
                    return options.length + 'ヶ月選択済み';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonTitle: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonClass:'search_order_shipping',
            nonSelectedText: '注文日検索',
        });
        $("a.multiselect.dropdown-toggle.search_order_shipping").on("click", function() {
            let button          = $("button.search_order_shipping");
            let aria_expanded   = button.attr("aria-expanded");
            if (!aria_expanded || aria_expanded == 'false') {
                setTimeout(function() {
                    button.click();
                }, 100);
            }
        })
        $('#search_order_otodoke').multiselect({
            includeSelectAllOption: true,
            selectAllText: 'すべて',
            enableFiltering: true,
            filterPlaceholder: '検索',
            disableIfEmpty: true,
            checkboxName: function(option) {
                return 'multiselect[]';
            },
            buttonWidth: '150px',
            buttonHeight: '34px',
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else if (options.length == 14) {
                    return 'すべて';
                }
                else if (options.length > 2) {
                    return options.length + 'ヶ月選択済み';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonTitle: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonClass:'search_order_otodoke',
            nonSelectedText: '注文日検索',
        });
        $("a.multiselect.dropdown-toggle.search_order_otodoke").on("click", function() {
            let button          = $("button.search_order_otodoke");
            let aria_expanded   = button.attr("aria-expanded");
            if (!aria_expanded || aria_expanded == 'false') {
                setTimeout(function() {
                    button.click();
                }, 100);
            }
        })
        $('#search_shipping_status').multiselect({
            includeSelectAllOption: true,
            selectAllText: 'すべて',
            // enableFiltering: true,
            // filterPlaceholder: '検索',
            checkboxName: function(option) {
                return 'multiselect[]';
            },
            buttonWidth: '150px',
            buttonHeight: '34px',
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else if (options.length == 14) {
                    return 'すべて';
                }
                else if (options.length > 2) {
                    return options.length + 'ヶ月選択済み';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonTitle: function(options, select) {
                if (options.length === 0) {
                    return '未選択';
                }
                else {
                     var labels = [];
                     options.each(function() {
                         if ($(this).attr('label') !== undefined) {
                             labels.push($(this).attr('label'));
                         }
                         else {
                             labels.push($(this).html());
                         }
                     });
                     labels.reverse();
                     return labels.join(', ') + '';
                }
            },
            buttonClass:'search_shipping_status',
            nonSelectedText: '注文日検索',
        });
        $("a.multiselect.dropdown-toggle.search_shipping_status").on("click", function() {
            let button          = $("button.search_shipping_status");
            let aria_expanded   = button.attr("aria-expanded");
            if (!aria_expanded || aria_expanded == 'false') {
                setTimeout(function() {
                    button.click();
                }, 250);
            }
        });
        function handleSearch(target) {
            let name                = target.name;
            let value               = target.value;
            let origin              = window.location.origin;
            let pathname            = window.location.pathname;
            let search              = window.location.search;
            pathname                += "?pageno=1";

            if (name == 'search_order_shipping') {
                clearTimeout(typingTimer);
                loadingOverlay('hide');

                typingTimer = setTimeout(function () {
                    loadingOverlay();
                    handelChangeShipping(origin, pathname, search);
                }, 1000);
            }
            if (name == 'search_order_otodoke') {
                clearTimeout(typingTimer);
                loadingOverlay('hide');

                typingTimer = setTimeout(function () {
                    loadingOverlay();
                    handelChangeOtodoke(origin, pathname, search);
                }, 1000);
            }
            if (name == 'search_shipping_status') {
                clearTimeout(typingTimer);
                loadingOverlay('hide');

                typingTimer = setTimeout(function () {
                    loadingOverlay();
                    handelChangeStatus(origin, pathname, search);
                }, 1000);
            }
        }
        function handelChangeShipping(origin, pathname) {
            let value       = $("#search_order_shipping").val();
            $.each(value, function(key, item) {
                pathname    += "&order_shipping[]=" + item;
            });
            window.location.href     = origin + pathname;
        }

        function handelChangeOtodoke(origin, pathname, search) {
            let value           = $("#search_order_otodoke").val();
            let shipping_code   = $("#search_order_otodoke option:selected").last().val();
            pathname            += "&order_otodoke[]=" + shipping_code;

            $.each(value, function(key, item) {
                pathname        += "&order_otodoke[]=" + item;
            });
            window.location.href     = origin + pathname;
        }
        function handelChangeStatus(origin, pathname, search) {
            let value = $("#search_shipping_status").val();
            $.each(value, function(key, item) {
                pathname += "&shipping_status[]=" + item;
            });
            window.location.href = origin + pathname;
        }
    </script>
{% endblock %}
