{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends 'default_frame.twig' %}

{% set body_class = 'cart_page' %}
{% block javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script >
        function  previewUrl() {
        let urlBack = document.referrer;

        if (urlBack == '') {
            window.location.href = '/';
        }

        else {
            if (urlBack.indexOf('products/list') > -1) {
                window.location.href = urlBack;
            }

            else {
                window.location.href = '/products/list';
            }
        }
    }

        var typingTimer;
        var doneTypingInterval = 500;
        var flg_key_up = false;

        $('.inputCart').keyup(function(event) {
            flg_key_up = true;
            clearTimeout(typingTimer);
            loadingOverlay('hide');
            $(".ec-blockBtn--action").attr('disabled', true);
            $(".ec-blockBtn--action").css('pointer-events', 'none');
            $(".ec-blockBtn--cancel").attr('disabled', true);
            $(".ec-blockBtn--cancel").css('pointer-events', 'none');

            if ( event.key == "Enter") {
                typingTimer = setTimeout(function () {
                    loadingOverlay();
                    handelChangeQuantity(event.target);
                }, doneTypingInterval);

            } else {
                typingTimer = setTimeout(function () {
                    loadingOverlay();
                    handelChangeQuantity(event.target);
                }, 1000);
            }
        });

        $('.inputCart').change(function(event) {
            if (flg_key_up) {
                return;
            }
            clearTimeout(typingTimer);
            loadingOverlay('hide');
            $(".ec-blockBtn--action").attr('disabled', true);
            $(".ec-blockBtn--action").css('pointer-events', 'none');
            $(".ec-blockBtn--cancel").attr('disabled', true);
            $(".ec-blockBtn--cancel").css('pointer-events', 'none');

            typingTimer = setTimeout(function () {
                loadingOverlay();
                handelChangeQuantity(event.target);
            }, doneTypingInterval);
        });

        function handelChangeQuantity(target) {
            let value = target.value.trim();
            let id = target.id;
            let step = $(target).attr('step');
            let current_value = $(target).attr('current_value');
            let productclassid = $(target).attr('productclassid');
            let flg = true;

            let input = document.getElementById(id);
            input.setCustomValidity('');

            if (value == "") {
                input.setCustomValidity('{{ 'front.product.not_input_quantity'|trans }}');
                input.reportValidity();
                flg = false;
            }

            if (parseInt(value) == 0 && (parseInt(step) == 1)) {
                input.setCustomValidity(step+'{{ 'front.product.invalid_quantity'|trans }}');
                input.reportValidity();
                flg = false;
            }

            if (parseInt(value) == 0 && (parseInt(step) != 1)) {
                let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                msgShow             = msgShow.replace('%number%', step);
                input.setCustomValidity(msgShow);
                input.reportValidity();
                flg = false;
            }

            if (parseInt(value) % parseInt(step)  !== 0) {
                let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                msgShow             = msgShow.replace('%number%', step);
                input.setCustomValidity(msgShow);
                input.reportValidity();
                flg = false;
            }

            if (parseInt(value) == parseInt(current_value)) {
                flg = false;
            }

            if (flg) {
                $.cookie( 'quantity' + id, value, { path: '/' });

                // Call ajax update cart
                $.ajax({
                    url: '/cart/update_cart',
                    type: 'POST',
                    dataType: "json",
                    timeout: 1000,
                    async:false,
                    data: {
                        '_token':'{{ csrf_token('_token') }}',
                        'current_quantity': current_value,
                        'quantity': value,
                        'productClassId':productclassid,
                    },
                    beforeSend: function( xhr ) {
                        loadingOverlay();
                    }
                })
                .done(function(data) {
                    if (data.status) {
                        window.location.reload();
                    } else {
                        console.log(data.msg);
                    }
                })
                .fail(function(data) {
                    console.log(data);
                }).always(function() {
                });
            }

            setTimeout(function () {
                loadingOverlay('hide');
                $(".ec-blockBtn--action").attr('disabled', false);
                $(".ec-blockBtn--action").css('pointer-events', 'auto');
                $(".ec-blockBtn--cancel").attr('disabled', false);
                $(".ec-blockBtn--cancel").css('pointer-events', 'auto');
            }, 1000);
        }

        $('.ec-blockBtn--action').click(function() {
            let flg = true;

            $( ".inputCart" ).each(function( index ) {
                let value = $(this).val()
                let id = $(this).attr('id');
                let step = $(this).attr('step');

                let input = document.getElementById(id);
                input.setCustomValidity('');

                if (value == "") {
                    input.setCustomValidity('{{ 'front.product.not_input_quantity'|trans }}');
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) == 0 && (parseInt(step) == 1)) {
                    input.setCustomValidity(step+'{{ 'front.product.invalid_quantity'|trans }}');
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) == 0 && (parseInt(step) != 1)) {
                    let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                    msgShow             = msgShow.replace('%number%', step);
                    input.setCustomValidity(msgShow);
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) % parseInt(step)  !== 0) {
                    let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                    msgShow             = msgShow.replace('%number%', step);
                    input.setCustomValidity(msgShow);
                    input.reportValidity();
                    flg = false;
                }
            });

            if (flg == true) {
                {% if onecart_key|length > 0 %}
                    let cart_buystep = "{{ path('cart_buystep', {'cart_key':onecart_key}) }}";
                    window.location.href = cart_buystep;
                {% endif %}
            }
        });

        $('.ec-blockBtn--cancel').click(function() {
            let flg = true;

            $( ".inputCart" ).each(function( index ) {
                let value = $(this).val()
                let id = $(this).attr('id');
                let step = $(this).attr('step');

                let input = document.getElementById(id);
                input.setCustomValidity('');

                if (value == "") {
                    input.setCustomValidity('{{ 'front.product.not_input_quantity'|trans }}');
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) == 0 && (parseInt(step) == 1)) {
                    input.setCustomValidity(step+'{{ 'front.product.invalid_quantity'|trans }}');
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) == 0 && (parseInt(step) != 1)) {
                    let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                    msgShow             = msgShow.replace('%number%', step);
                    input.setCustomValidity(msgShow);
                    input.reportValidity();
                    flg = false;
                }

                if (parseInt(value) % parseInt(step)  !== 0) {
                    let msgShow         = "{{ 'front.product.invalid_quantity_big'|trans }}";
                    msgShow             = msgShow.replace('%number%', step);
                    input.setCustomValidity(msgShow);
                    input.reportValidity();
                    flg = false;
                }
            });

            if (flg == true) {
                previewUrl();
            }
        });

        $(function() {
            $(document).on("keydown", "input", function(event) {
                return event.key != "Enter";
            });
        })
    </script>
{% endblock javascript %}
{% block main %}
    <style>

        .inputCart{
           width:100px ;
            text-align: right;
        }

         .standar_price{
             color: #00B050;
             font-size: 100% !important;
         }
        .good_price{
            color: #FF0000;
            font-size: 100% !important;
        }


    </style>
    <div class="ec-role">
        <div class="ec-pageHeader">
            <h1>{{ 'front.cart.title'|trans }}</h1>
        </div>
    </div>
    <div class="ec-cartRole">
        <div class="ec-cartRole__progress">
            <ul class="ec-progress">
                {% set step = 1 %}
                <li class="ec-progress__item is-complete">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">{{ 'front.cart.nav__cart_items'|trans }}
                    </div>
                </li>
                {% if is_granted('ROLE_USER') == false %}
                    <li class="ec-progress__item">
                        <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                        </div>
                        <div class="ec-progress__label">{{ 'front.cart.nav__customer_info'|trans }}
                        </div>
                    </li>
                {% endif %}
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">{{ 'front.cart.nav__order'|trans }}
                    </div>
                </li>
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">{{ 'front.cart.nav__confirm'|trans }}
                    </div>
                </li>
                <li class="ec-progress__item">
                    <div class="ec-progress__number">{{ step }}{% set step = step + 1 %}
                    </div>
                    <div class="ec-progress__label">{{ 'front.cart.nav__complete'|trans }}
                    </div>
                </li>
            </ul>
        </div>
        {% set productStr = app.session.flashbag.get('eccube.front.request.product') %}
        {% for error in app.session.flashbag.get('eccube.front.request.error') %}
            {% set idx = loop.index0 %}
            <div class="ec-cartRole__error">
                <div class="ec-alert-warning">
                    <div class="ec-alert-warning__icon"><img src="{{ asset('assets/icon/exclamation-white.svg') }}"></div>
                    <div class="ec-alert-warning__text">
                        {% if productStr[idx] is defined %}
                            {{ error|trans({'%product%':productStr[idx]})|nl2br }}
                        {% else %}
                            {{ error|trans|nl2br }}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        {% for error in app.session.flashbag.get('eccube.front.cart.error') %}
            <div class="ec-cartRole__error">
                <div class="ec-alert-warning">
                    <div class="ec-alert-warning__icon"><img src="{{ asset('assets/icon/exclamation-white.svg') }}"></div>
                    <div class="ec-alert-warning__text">
                        {{ error|trans|nl2br }}
                    </div>
                </div>
            </div>
        {% endfor %}
        {% if totalQuantity > 0 %}
            <div class="ec-cartRole__totalText">
                {# Check mst_customer.price_view_flg #}
                {% if global_service.getPriceViewFlg %}
                    <p>
                        {{ 'front.cart.total_price'|trans({ '%price%': roundPriceZeroTotal(totalPrice) }) | raw }}
                    </p>
                {% endif %}
            </div>

            {% if Carts|length > 1 %}
                <div class="ec-cartRole__error">
                    <div class="ec-alert-warning">
                        <div class="ec-alert-warning__text">
                            {{ 'front.cart.divide_cart'|trans|nl2br }}
                        </div>
                    </div>
                </div>
            {% endif %}

            <form name="form" id="form_cart"  style="width: 100%" class="" method="post" action="{{ url('cart') }}">
                {% if app.user==null %}
                    <div class="ec-cartRole__cart" style="text-align: center;color:#00B050">未ログインのため、標準単価で金額を算出しています</div>
                {% endif %}
                {% for CartIndex,Cart in Carts %}
                    {% set cartKey = Cart.cart_key %}
                    <script>
                        CartKey ='{{ Cart.cart_key }}';
                    </script>
                    {% for error in app.session.flashbag.get('eccube.front.cart.' ~ cartKey ~ '.request.error') %}
                        <div class="ec-cartRole__error">
                            <div class="ec-alert-warning">
                                <div class="ec-alert-warning__icon"><img src="{{ asset('assets/icon/exclamation-white.svg') }}"></div>
                                <div class="ec-alert-warning__text">
                                    {{ error|trans|nl2br }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <div class="ec-cartRole__cart">
                        <div class="ec-cartTable">
                            <ol class="ec-cartHeader">
                                <li class="ec-cartHeader__label">{{ 'front.cart.delete'|trans }}</li>
                                <li class="ec-cartHeader__label">
                                    {% if global_service.getCartProductType == 2%}
                                        {{ 'front.cart.product'|trans }} {{ 'front.cart.special_product'|trans }}
                                    {% else %}
                                        {{ 'front.cart.product'|trans }}
                                    {% endif %}
                                </li>
                                <li class="ec-cartHeader__label">{{ 'common.quantity'|trans }}</li>
                                <li class="ec-cartHeader__label">{{ 'common.subtotal'|trans }}</li>
                            </ol>
                            {% for CartItem in Cart.CartItems %}
                                {% set ProductClass = CartItem.ProductClass %}
                                {% set Product = ProductClass.Product %}
                                {#{% set MstProduct = hsProductId[Product.id] %}#}

                                <ul class="ec-cartRow">
                                    <li class="ec-cartRow__delColumn">
                                        <a href="{{ url('cart_handle_item', {'operation': 'remove', 'productClassId': ProductClass.id }) }}" {{ csrf_token_for_anchor() }} class="ec-icon" data-method="put" data-message="カートから商品を削除してもよろしいですか?">
                                            <img src="{{ asset('assets/icon/cross.svg') }}" alt="delete">
                                        </a>
                                    </li>
                                    <li class="ec-cartRow__contentColumn">
                                        <div class="ec-cartRow__img">
                                            <a target="_blank" href="{{ url('product_detail', {id : Product.id} ) }}">
                                                <img src="{{ asset(Product.MainListImage|no_image_product, 'save_image') }}" alt="{{ Product.name }}"/>
                                            </a>
                                        </div>
                                        <div class="ec-cartRow__summary">
                                            <div class="ec-cartRow__name">
                                                <a  href="{{ url('product_detail', {id : Product.id} ) }}">{{ Product.name }}</a>
                                                <br>
                                                {{ Product.jan}}
                                            </div>
                                            <div class="ec-cartRow__unitPrice">
                                                {% if Product.quantity>1 %}
                                                    販売単位：{{ Product.quantity }}個/箱～
                                                {% else %}
                                                    販売単位：{{ Product.quantity }}個～
                                                {% endif %}
                                                {% set classShow = Product.price == Product.unit_price ? 'standar_price' : 'good_price' -%}

                                                {# Check mst_customer.price_view_flg #}
                                                {% if global_service.getPriceViewFlg %}
                                                    {% if  classShow=="good_price" %}
                                                        <span class="{{ classShow }}"> 販売単価：</span>
                                                    {% else %}
                                                        <span class="{{ classShow }}"> 標準単価：</span>
                                                    {% endif %}
                                                    <span class="{{ classShow }}">{{ roundPriceZero(CartItem.price) | raw }}</span>
                                                {% endif %}

                                               </div>

                                            {# Check mst_customer.price_view_flg #}
                                            {% if global_service.getPriceViewFlg %}
                                                <div class="ec-cartRow__sutbtotalSP">{{ 'common.subtotal__with_separator'|trans }}{{ roundPriceZeroTotal(CartItem.total_price) | raw }}</div>
                                            {% endif %}
                                        </div>
                                    </li>
                                    <li class="ec-cartRow__amountColumn">
                                        <div class="ec-cartRow__amountSP">{{ 'common.quantity__with_separator'|trans }}{{ CartItem.quantity|number_format }}</div>
                                        <input type="number" maxlength="5" class="inputCart quantity form-control" id="{{ Product.id }}" productclassid="{{ ProductClass.id }}" name="{{ Product.id }}" required="required" min="{{ Product.quantity }}" title="" current_value="{{ (CartItem.quantity * Product.quantity) }}" value="{{ (CartItem.quantity * Product.quantity) }}" step="{{ Product.quantity }}">
                                    </li>
                                    <li class="ec-cartRow__subtotalColumn">
                                        {# Check mst_customer.price_view_flg #}
                                        {% if global_service.getPriceViewFlg %}
                                            <div class="ec-cartRow__sutbtotal">{{ roundPrice(CartItem.total_price) | raw }}</div>
                                        {% endif %}
                                    </li>
                                </ul>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="ec-cartRole__progress">
                        {% if BaseInfo.delivery_free_amount and BaseInfo.delivery_free_quantity %}
                            <br/>
                            {% if is_delivery_free[cartKey] %}
                                {{ 'front.cart.delivery_fee_free__now'|trans }}
                            {% else %}
                                {# Check mst_customer.price_view_flg #}
                                {% if global_service.getPriceViewFlg %}
                                    {{ 'front.cart.delivery_fee_free__price_and_quantity'|trans({ '%price%': roundPrice(least[cartKey]), '%quantity%': quantity[cartKey]|number_format }) | raw }}
                                {% endif %}
                            {% endif %}
                        {% elseif BaseInfo.delivery_free_amount %}
                            <br/>
                            {% if is_delivery_free[cartKey] %}
                                {{ 'front.cart.delivery_fee_free__now'|trans }}
                            {% else %}
                                {# Check mst_customer.price_view_flg #}
                                {% if global_service.getPriceViewFlg %}
                                    {{ 'front.cart.delivery_fee_free__price'|trans({ '%price%': roundPrice(least[cartKey]) }) | raw }}
                                {% endif %}
                            {% endif %}
                        {% elseif BaseInfo.delivery_free_quantity %}
                            <br/>
                            {% if is_delivery_free[cartKey] %}
                                {{ 'front.cart.delivery_fee_free__now'|trans }}
                            {% else %}
                                {{ 'front.cart.delivery_fee_free__quantity'|trans({ '%quantity%': quantity[cartKey]|number_format }) | raw }}
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="ec-cartRole__actions">
                        {# Check mst_customer.price_view_flg #}
                        {% if global_service.getPriceViewFlg %}
                            <div class="ec-cartRole__total">{{ 'common.total__with_separator'|trans }}<span class="ec-cartRole__totalAmount">{{ roundPriceZeroTotal(Cart.totalPrice) | raw }}</span>
                        {% endif %}
                        </div>
                        <a class="ec-blockBtn--action" href="javascript:;">{{ 'front.cart.checkout'|trans }}</a>
                        {% if loop.last %}
                            <a class="ec-blockBtn--cancel" href="javascript:;">{{ 'front.cart.continue'|trans }}</a>
                        {% endif %}
                    </div>
                {% endfor %}
            </form>
        {% else %}
            {% for CartIndex,Cart in Carts %}
                {% set cartKey = Cart.cart_key %}
                {% for error in app.session.flashbag.get('eccube.front.cart.' ~ cartKey ~ '.request.error') %}
                    <div class="ec-cartRole__error">
                        <div class="ec-alert-warning">
                            <div class="ec-alert-warning__icon"><img src="{{ asset('assets/icon/exclamation-white.svg') }}"></div>
                            <div class="ec-alert-warning__text">
                                {{ error|trans|nl2br }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
            <div class="ec-role">
                <div class="ec-off3Grid">
                    <div class="ec-off3Grid__cell">
                        <div class="ec-alert-warning">
                            <div class="ec-alert-warning__icon"><img src="{{ asset('assets/icon/exclamation-white.svg') }}"></div>
                            <div class="ec-alert-warning__text">{{ 'front.cart.no_items'|trans }}</div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

{% endblock %}
